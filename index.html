<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kumo - Omnichord Digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@600;700&family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --sky-pink: #FFB7B2;
            --dusk-blue: #B2CEFE;
            --sun-glow: #FFD19A;
            --linen-paper: #F5F5DC;
            --retro-ink: #4A4A4A;
        }

        .bg-animated {
            background: linear-gradient(-45deg, #F5F5DC, #FFE4E1, #E6E6FA, #FFF5EE);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            color: var(--retro-ink);
            font-family: 'Quicksand', sans-serif;
            margin: 0;
            overflow-x: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        h1, h2, h3 { font-family: 'Outfit', sans-serif; }

        .logo-k {
            width: 32px; height: 32px;
            background: var(--sky-pink);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 14px; font-style: italic;
        }

        .nav-link {
            font-size: 10px; font-weight: 800; text-transform: uppercase;
            letter-spacing: 0.15em; opacity: 0.4; transition: all 0.3s;
            cursor: pointer; padding-bottom: 4px;
        }
        .nav-link.active { opacity: 1; border-bottom: 2px solid var(--sky-pink); color: var(--sky-pink); }

        .glass-card {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 32px;
        }

        /* --- STRUCTURE DE KUMO SYNCHRONISÉE --- */
        .kumo-wrapper {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block;
            will-change: transform;
            margin-top: 60px; /* Augmenté de 20px supplémentaires comme demandé */
        }

        .kumo-container {
            position: relative; width: 160px; height: 120px; margin: 0 auto;
            display: flex; justify-content: center; align-items: center;
        }

        .kumo-body {
            width: 120px; height: 70px; 
            background-color: white; 
            border-radius: 100px;
            position: relative; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease;
        }

        .kumo-body::before, .kumo-body::after {
            content: ''; 
            position: absolute; 
            background-color: inherit; 
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        
        .kumo-body::before { width: 65px; height: 65px; top: -35px; left: 15px; }
        .kumo-body::after { width: 55px; height: 55px; top: -25px; left: 60px; }

        .kumo-face {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; gap: 12px; z-index: 10;
        }

        .eye { width: 6px; height: 6px; background: var(--retro-ink); border-radius: 50%; transition: transform 0.1s; }
        .mouth {
            position: absolute; width: 10px; height: 5px;
            border-bottom: 2px solid var(--retro-ink); border-radius: 0 0 5px 5px;
            bottom: -10px; left: 10px; transition: height 0.1s;
        }

        /* --- LAYOUT INSTRUMENT --- */
        .instrument-layout {
            display: flex; gap: 15px; align-items: flex-start; width: 100%;
        }

        .chord-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; width: 40%; }
        .chord-btn {
            aspect-ratio: 1.1; background: white; border-radius: 12px;
            border: 2px solid transparent; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-weight: 800; font-size: 11px;
            box-shadow: 0 3px 0 rgba(0,0,0,0.05); transition: all 0.1s; cursor: pointer;
        }
        .chord-btn.active { 
            background: var(--sun-glow); transform: translateY(2px); 
            box-shadow: 0 1px 0 rgba(0,0,0,0.1);
        }
        .chord-btn.guide-active { border-color: var(--sky-pink); animation: pulseGuide 1.5s infinite; }

        @keyframes pulseGuide {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 183, 178, 0.4); }
            50% { box-shadow: 0 0 15px 5px rgba(255, 183, 178, 0.4); }
        }

        .strum-plate {
            width: 60%; height: 320px; border-radius: 20px; position: relative; overflow: hidden;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3); touch-action: none;
            cursor: crosshair; display: flex; flex-direction: column;
        }

        .omni-string {
            width: 100%; flex: 1; position: relative; display: flex; align-items: center;
        }

        .omni-string::after {
            content: ''; height: 1px; width: 100%; background: rgba(0, 0, 0, 0.05);
        }

        .lyrics-container {
            height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; position: relative; margin-top: 10px;
        }

        .lyric-line {
            font-size: 16px; font-weight: 700; color: var(--retro-ink); 
            transition: opacity 0.3s, transform 0.3s;
            position: absolute; width: 100%;
        }

        .lyric-sub { font-size: 10px; opacity: 0.4; margin-top: 2px; font-weight: 500; font-style: italic; }

        .progress-container { 
            width: 160px; height: 4px; background: rgba(0,0,0,0.05); 
            border-radius: 10px; margin-top: 8px; overflow: hidden; 
        }
        .progress-bar { height: 100%; width: 0%; background: var(--sky-pink); transition: width 0.1s linear; }

        .song-btn {
            background: white; border-radius: 10px; padding: 6px; font-size: 8px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s; border: 1px solid transparent;
            text-align: center;
        }
        .song-btn.active { border-color: var(--sky-pink); color: var(--sky-pink); box-shadow: 0 4px 10px rgba(255, 183, 178, 0.2); }

        .partition-badge {
            background: #4A4A4A; color: white; padding: 3px 10px; border-radius: 20px; font-size: 9px; font-weight: bold;
        }

        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #audio-overlay {
            position: fixed; inset: 0; background: rgba(245, 245, 220, 0.95);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
    </style>
</head>
<body class="bg-animated">

    <div id="audio-overlay" onclick="unlockAudio()">
        <div class="logo-k w-16 h-16 text-xl mb-4 shadow-xl">K</div>
        <h2 class="text-2xl font-bold mb-2">Prêt à jouer ?</h2>
        <p class="opacity-60 text-sm mb-6 italic">Cliquez pour activer le son.</p>
        <button class="bg-white px-8 py-3 rounded-full shadow-lg font-bold text-xs tracking-widest uppercase">Entrer</button>
    </div>

    <nav class="max-w-4xl mx-auto mt-4 mb-4 flex justify-between items-center bg-white/40 backdrop-blur-xl p-3 rounded-2xl border border-white/40 shadow-sm sticky top-2 z-50 mx-2">
        <div class="flex items-center gap-2">
            <div class="logo-k shadow-md">K</div>
            <span class="font-bold tracking-tighter uppercase text-[9px]">Kumo Engine v2.5</span>
        </div>
        <div class="flex gap-4">
            <div onclick="showPage('concept')" id="nav-concept" class="nav-link active">Concept</div>
            <div onclick="showPage('instrument')" id="nav-instrument" class="nav-link">Instrument</div>
            <div onclick="showPage('playground')" id="nav-playground" class="nav-link">Playground</div>
        </div>
    </nav>

    <!-- Page Concept -->
    <main id="page-concept" class="page-content active max-w-4xl mx-auto px-4 pb-12 space-y-8">
        <header class="text-center py-4">
            <span class="text-[9px] uppercase tracking-[0.4em] font-bold text-[#FFB7B2]">Cloud Soundscape</span>
            <h1 class="text-4xl font-bold tracking-tight text-retro-ink mt-2">Nuage Mélodique</h1>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <section class="glass-card p-6 flex flex-col items-center text-center">
                <div class="kumo-container">
                    <div class="kumo-wrapper" id="kumo-concept-wrap">
                        <div class="kumo-body" id="kumo-concept-body">
                            <div class="kumo-face">
                                <div class="eye"></div><div class="eye"></div><div class="mouth"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section class="glass-card p-6 flex flex-col justify-center">
                <p class="text-[13px] opacity-70 italic text-center">"Kumo réagit à votre jeu : ses formes et ses couleurs vibrent à l'unisson de vos mélodies."</p>
            </section>
        </div>
    </main>

    <!-- Page Instrument -->
    <main id="page-instrument" class="page-content max-w-2xl mx-auto px-4 pb-12">
        
        <div id="playground-ui" class="hidden glass-card p-4 mb-4 w-full border-pink-100 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <div class="partition-badge" id="partition-display">Sélectionnez un titre</div>
                <button id="play-btn" class="bg-pink-400 text-white px-6 py-2 rounded-full text-[9px] font-bold uppercase tracking-widest shadow-lg active:scale-95 transition-all">Jouer</button>
            </div>
            <div class="grid grid-cols-5 gap-1.5" id="song-grid"></div>
        </div>

        <div class="w-full flex flex-col items-center mb-8">
            <div class="kumo-container">
                <div class="kumo-wrapper" id="kumo-inst-wrap">
                    <div class="kumo-body" id="kumo-inst-body">
                        <div class="kumo-face">
                            <div class="eye"></div><div class="eye"></div><div class="mouth"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="lyrics-container w-full" id="lyrics-display">
                <div class="lyric-line" id="current-lyric">Kumo attend votre musique</div>
            </div>

            <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>
        </div>

        <div class="w-full glass-card p-4 space-y-4 shadow-2xl border-white/60 relative">
            <div class="flex justify-between items-center px-1">
                <span class="text-[7px] font-bold uppercase tracking-widest opacity-20">Harmonie</span>
                <span class="text-[9px] font-bold uppercase text-[#FFB7B2]" id="current-chord-label">Choisissez un accord</span>
                <span class="text-[7px] font-bold uppercase tracking-widest opacity-20">Cordes</span>
            </div>
            <div class="instrument-layout">
                <div class="chord-grid" id="chord-grid"></div>
                <div class="strum-plate shadow-inner" id="strum-plate"></div>
            </div>
        </div>
    </main>

    <script>
        // Variables globales pour le DOM
        let playBtn = null;
        let progressBar = null;
        let currentLyric = null;
        let kumoInstBody = null;
        let kumoInstWrap = null;
        let currentChordLabel = null;

        const playlist = [
            { title: "Yume", bpm: 80, sequence: [
                { time: 0, lyrics: "Sora wa pinku iro...", sub: "Le ciel est rose...", chord: "C", scale: "Do Majeur" },
                { time: 8, lyrics: "Kaze ga utau yo.", sub: "Le vent chante.", chord: "F", scale: "Fa Majeur" },
                { time: 16, lyrics: "Issho ni odorou !", sub: "Dansons ensemble !", chord: "G", scale: "Sol Majeur" },
                { time: 24, lyrics: "Mata ne...", sub: "À bientôt...", chord: "C", scale: "Do Majeur" }
            ]},
            { title: "Kumo", bpm: 100, sequence: [
                { time: 0, lyrics: "Je plane haut...", sub: "Flying high...", chord: "Am", scale: "La Mineur" },
                { time: 10, lyrics: "Entre les formes.", sub: "Between shapes.", chord: "Dm", scale: "Ré Mineur" },
                { time: 20, lyrics: "Nuage de son.", sub: "Cloud of sound.", chord: "F", scale: "Fa Majeur" }
            ]},
            // 10 chansons maintenues
            { title: "Sora", bpm: 90, sequence: [{ time: 0, lyrics: "Bleu infini", sub: "Infinite blue", chord: "C" }] },
            { title: "Mizu", bpm: 75, sequence: [{ time: 0, lyrics: "L'eau claire", sub: "Clear water", chord: "F" }] },
            { title: "Kaze", bpm: 110, sequence: [{ time: 0, lyrics: "Le vent souffle", sub: "The wind blows", chord: "G" }] },
            { title: "Hi", bpm: 120, sequence: [{ time: 0, lyrics: "Feu sacré", sub: "Sacred fire", chord: "Am" }] },
            { title: "Yama", bpm: 70, sequence: [{ time: 0, lyrics: "La montagne", sub: "The mountain", chord: "Em" }] },
            { title: "Mori", bpm: 85, sequence: [{ time: 0, lyrics: "Forêt dense", sub: "Dense forest", chord: "Bb" }] },
            { title: "Hoshi", bpm: 60, sequence: [{ time: 0, lyrics: "Étoile filante", sub: "Shooting star", chord: "D" }] },
            { title: "Tsuki", bpm: 65, sequence: [{ time: 0, lyrics: "Lune d'argent", sub: "Silver moon", chord: "C" }] }
        ];

        const chords = {
            'C': [261.63, 329.63, 392.00], 'F': [349.23, 440.00, 523.25], 'G': [392.00, 493.88, 587.33],
            'Am': [220.00, 261.63, 329.63], 'Dm': [293.66, 349.23, 440.00], 'Em': [329.63, 392.00, 493.88],
            'Bb': [233.08, 293.66, 349.23], 'D': [293.66, 369.99, 440.00]
        };

        let audioCtx = null;
        let currentChordFreqs = null;
        let lastString = -1;
        let isPlaying = false;
        let playbackInterval = null;
        let selectedSongIdx = 0;
        let lastLyricTime = -1;

        function unlockAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            audioCtx.resume();
            document.getElementById('audio-overlay').style.display = 'none';
            playBtn = document.getElementById('play-btn');
            progressBar = document.getElementById('progress-bar');
            currentLyric = document.getElementById('current-lyric');
            kumoInstBody = document.getElementById('kumo-inst-body');
            kumoInstWrap = document.getElementById('kumo-inst-wrap');
            currentChordLabel = document.getElementById('current-chord-label');
            
            if(playBtn) playBtn.onclick = startSong;
        }

        function playTone(freq) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 1.2);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 1.2);
            animateKumoColorSync(freq);
        }

        function animateKumoColorSync(freq) {
            if (!kumoInstBody || !kumoInstWrap) return;
            const mouth = document.querySelector('.mouth');
            
            let color = '#FFB7B2'; 
            if (freq < 300) color = '#B2CEFE'; 
            if (freq > 450) color = '#FFD19A'; 

            kumoInstBody.style.backgroundColor = color;
            kumoInstWrap.style.transform = 'scale(1.1)';
            if(mouth) mouth.style.height = '12px';
            
            setTimeout(() => {
                kumoInstBody.style.backgroundColor = 'white';
                kumoInstWrap.style.transform = 'scale(1)';
                if(mouth) mouth.style.height = '5px';
            }, 250);
        }

        function animateKumoPulse(bpm) {
            if (!kumoInstWrap || !isPlaying) return;
            const beatMs = 60000 / bpm;
            const phase = (Date.now() % beatMs) / beatMs;
            const s = 1 + Math.sin(phase * Math.PI * 2) * 0.04;
            kumoInstWrap.style.transform = `scale(${s})`;
        }

        function selectSong(idx) {
            selectedSongIdx = idx;
            document.querySelectorAll('.song-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
        }

        function selectChord(name) {
            currentChordFreqs = chords[name];
            document.querySelectorAll('.chord-btn').forEach(b => b.classList.toggle('active', b.id === `chord-btn-${name}`));
            if(currentChordLabel) currentChordLabel.innerText = "Accord : " + name;
        }

        function startSong() {
            if (isPlaying) { stopSong(); return; }
            isPlaying = true;
            if(playBtn) playBtn.innerText = "Stop";
            const song = playlist[selectedSongIdx];
            const startTime = Date.now();
            
            playbackInterval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                if(progressBar) progressBar.style.width = Math.min((elapsed / 30) * 100, 100) + '%';
                
                let activeSeq = song.sequence[0];
                song.sequence.forEach(s => { if(elapsed >= s.time) activeSeq = s; });
                
                if (lastLyricTime !== activeSeq.time) {
                    lastLyricTime = activeSeq.time;
                    if(currentLyric) {
                        currentLyric.innerHTML = `<div>${activeSeq.lyrics}</div><div class="lyric-sub">${activeSeq.sub}</div>`;
                    }
                    document.querySelectorAll('.chord-btn').forEach(b => b.classList.remove('guide-active'));
                    const guideBtn = document.getElementById(`chord-btn-${activeSeq.chord}`);
                    if(guideBtn) guideBtn.classList.add('guide-active');
                }

                animateKumoPulse(song.bpm);
                if (elapsed >= 30) stopSong();
            }, 50);
        }

        function stopSong() {
            isPlaying = false;
            if(playBtn) playBtn.innerText = "Jouer";
            clearInterval(playbackInterval);
            if(progressBar) progressBar.style.width = '0%';
            if(kumoInstWrap) kumoInstWrap.style.transform = 'scale(1)';
        }

        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const isPlayground = (pageId === 'playground');
            const targetId = isPlayground ? 'instrument' : pageId;
            const targetPage = document.getElementById('page-' + targetId);
            const targetNav = document.getElementById('nav-' + pageId);
            const playgroundUi = document.getElementById('playground-ui');
            
            if(targetPage) targetPage.classList.add('active');
            if(targetNav) targetNav.classList.add('active');
            if(playgroundUi) playgroundUi.classList.toggle('hidden', !isPlayground);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const chordGrid = document.getElementById('chord-grid');
            Object.keys(chords).forEach(name => {
                const btn = document.createElement('div');
                btn.className = 'chord-btn'; btn.id = `chord-btn-${name}`;
                btn.innerHTML = `<span>${name}</span>`;
                btn.onclick = () => selectChord(name);
                chordGrid.appendChild(btn);
            });

            const songGrid = document.getElementById('song-grid');
            playlist.forEach((s, i) => {
                const btn = document.createElement('button');
                btn.className = `song-btn ${i===0?'active':''}`;
                btn.innerText = s.title; btn.onclick = () => selectSong(i);
                songGrid.appendChild(btn);
            });

            const strumPlate = document.getElementById('strum-plate');
            for(let i=0; i<14; i++) strumPlate.appendChild(document.createElement('div')).className = 'omni-string';

            function handleStrum(e) {
                if (!currentChordFreqs) return;
                const rect = strumPlate.getBoundingClientRect();
                const clientY = (e.touches) ? e.touches[0].clientY : e.clientY;
                const y = Math.max(0, Math.min(clientY - rect.top, rect.height));
                const stringIdx = Math.floor((y / rect.height) * 14);
                if (stringIdx !== lastString) {
                    lastString = stringIdx;
                    const freq = currentChordFreqs[stringIdx % 3] * Math.pow(2, Math.floor(stringIdx / 4));
                    playTone(freq);
                }
            }

            strumPlate.addEventListener('mousemove', (e) => e.buttons === 1 && handleStrum(e));
            strumPlate.addEventListener('touchstart', (e) => { e.preventDefault(); handleStrum(e); }, {passive: false});
            strumPlate.addEventListener('touchmove', (e) => { e.preventDefault(); handleStrum(e); }, {passive: false});
            strumPlate.addEventListener('touchend', () => lastString = -1);
        });
    </script>
</body>
</html>
